<% content_for(:title) { "Comparison" } %>

<div class="space-y-8">
  <div>
    <div class="mb-2">
      <% if @comparison.test_run %>
        <%= link_to dashboard_project_test_run_path(@project, @comparison.test_run), class: "btn-ghost text-sm" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to Test Run
        <% end %>
      <% else %>
        <%= link_to dashboard_project_pages_path(@project), class: "btn-ghost text-sm" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
          </svg>
          Back to Pages
        <% end %>
      <% end %>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <h1 class="section-header"><%= @comparison.page&.name || 'Comparison' %></h1>
        <p class="section-subheader"><%= @comparison.page&.path %></p>
      </div>
      <div class="flex items-center gap-3">
        <% case @comparison.status %>
        <% when 'passed' %>
          <span class="badge badge-success">Passed</span>
        <% when 'failed' %>
          <span class="badge badge-error">Failed</span>
        <% when 'pending' %>
          <span class="badge badge-neutral">Pending</span>
        <% when 'error' %>
          <span class="badge badge-warning">Error</span>
        <% end %>

        <% if @comparison.review_status == 'approved' %>
          <span class="badge badge-info">Approved</span>
        <% elsif @comparison.review_status == 'rejected' %>
          <span class="badge badge-warning">Rejected</span>
        <% end %>

        <% if @comparison.needs_review? %>
          <div class="flex gap-2">
            <%= button_to "Approve", approve_dashboard_project_comparison_path(@project, @comparison), method: :post, class: "btn-primary" %>
            <%= button_to "Reject", reject_dashboard_project_comparison_path(@project, @comparison), method: :post, class: "btn-danger" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if @comparison.diff_percentage.present? %>
    <div class="card card-body bg-dm-surface border border-dm">
      <div class="flex items-center justify-between">
        <span class="text-sm text-dm-muted">Difference</span>
        <span class="text-2xl font-semibold" style="color: <%= @comparison.diff_percentage > (@comparison.page&.threshold || 1) ? 'var(--dm-error)' : 'var(--dm-success)' %>;">
          <%= number_to_percentage(@comparison.diff_percentage, precision: 2) %>
        </span>
      </div>
      <div class="mt-3 w-full rounded-full h-2.5 bg-dm-surface-light">
        <div class="h-2.5 rounded-full transition-all" style="background: <%= @comparison.diff_percentage > (@comparison.page&.threshold || 1) ? 'var(--dm-error)' : 'var(--dm-success)' %>; width: <%= [@comparison.diff_percentage, 100].min %>%;"></div>
      </div>
    </div>
  <% end %>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Baseline -->
    <div class="space-y-3">
      <h2 class="text-[15px] font-semibold text-dm">Baseline</h2>
      <div class="card overflow-hidden bg-dm-surface border border-dm">
        <% if @baseline&.screenshot&.attached? %>
          <%= image_tag public_storage_url(@baseline.screenshot), class: "w-full h-auto" %>
        <% else %>
          <div class="p-12 text-center bg-dm-surface-light">
            <span class="text-sm text-dm-muted">No baseline image</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Snapshot -->
    <div class="space-y-3">
      <h2 class="text-[15px] font-semibold text-dm">Snapshot</h2>
      <div class="card overflow-hidden bg-dm-surface border border-dm">
        <% if @snapshot&.screenshot&.attached? %>
          <%= image_tag public_storage_url(@snapshot.screenshot), class: "w-full h-auto" %>
        <% else %>
          <div class="p-12 text-center bg-dm-surface-light">
            <span class="text-sm text-dm-muted">No snapshot image</span>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Diff -->
    <div class="space-y-3">
      <h2 class="text-[15px] font-semibold text-dm">Difference</h2>
      <div class="card overflow-hidden bg-dm-surface border border-dm">
        <% if @comparison.diff_image&.attached? %>
          <%= image_tag public_storage_url(@comparison.diff_image), class: "w-full h-auto" %>
        <% else %>
          <div class="p-12 text-center bg-dm-surface-light">
            <span class="text-sm text-dm-muted">No diff image</span>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <% if @comparison.needs_review? %>
    <div class="card card-body" style="background: var(--dm-warning-bg); border: 1px solid var(--dm-warning-border);">
      <h3 class="text-[15px] font-semibold mb-2" style="color: var(--dm-warning);">Update Baseline?</h3>
      <p class="text-sm mb-4 text-dm-muted">If this change is intentional, you can approve it and update the baseline.</p>
      <%= form_with url: approve_dashboard_project_comparison_path(@project, @comparison), method: :post, class: "flex items-center gap-4" do %>
        <label class="flex items-center">
          <%= check_box_tag :update_baseline, '1', false, class: "rounded mr-2", style: "border-color: var(--dm-warning); color: var(--dm-warning);" %>
          <span class="text-sm text-dm-muted">Update baseline to new snapshot</span>
        </label>
        <%= submit_tag "Approve with options", class: "btn-primary" %>
      <% end %>
    </div>
  <% end %>
</div>
