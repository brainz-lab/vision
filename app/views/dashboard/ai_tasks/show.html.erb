<% content_for(:title) { "Task Details" } %>

<div class="space-y-6">
  <!-- Breadcrumb & Header -->
  <div>
    <%= link_to dashboard_project_ai_tasks_path(@project), class: "btn-ghost text-sm mb-4" do %>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"/>
      </svg>
      All Tasks
    <% end %>

    <div class="flex items-start justify-between gap-6">
      <div class="flex-1 min-w-0">
        <!-- Status Badge -->
        <div class="flex items-center gap-3 mb-3">
          <% case @task.status %>
          <% when 'pending' %>
            <span class="badge badge-neutral">
              <span class="w-2 h-2 rounded-full animate-pulse bg-stone-400"></span>
              Pending
            </span>
          <% when 'running' %>
            <span class="badge badge-info">
              <span class="w-2 h-2 rounded-full animate-pulse bg-blue-500"></span>
              Running
            </span>
          <% when 'completed' %>
            <span class="badge badge-success">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
              Completed
            </span>
          <% when 'stopped' %>
            <span class="badge badge-warning">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
              </svg>
              Stopped
            </span>
          <% when 'timeout' %>
            <span class="badge badge-error">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
              </svg>
              Timeout
            </span>
          <% when 'error' %>
            <span class="badge badge-error">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              Error
            </span>
          <% end %>

          <div class="flex items-center gap-2 text-xs text-dm-muted">
            <span class="badge badge-neutral"><%= @task.model %></span>
            <span class="badge badge-neutral"><%= @task.browser_provider %></span>
          </div>
        </div>

        <!-- Task Instruction -->
        <h1 class="section-header text-xl"><%= @task.instruction %></h1>

        <% if @task.start_url.present? %>
          <p class="section-subheader text-sm truncate">
            <svg class="w-3.5 h-3.5 inline-block mr-1 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
            </svg>
            <%= @task.start_url %>
          </p>
        <% end %>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-2 flex-shrink-0">
        <% if @task.screenshots.attached? %>
          <button onclick="openReplayModal()" class="btn-secondary">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
            </svg>
            Watch Replay
          </button>
        <% end %>
        <%= button_to retry_dashboard_project_ai_task_path(@project, @task),
            method: :post,
            form: { data: { turbo_confirm: "Run this task again with the same parameters?" } },
            class: "btn-primary" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          Retry
        <% end %>
      </div>
    </div>
  </div>

  <!-- Quick Stats Bar -->
  <div class="grid grid-cols-4 gap-4">
    <div class="stat-card bg-dm-surface border border-dm">
      <div class="stat-label text-dm-muted">Duration</div>
      <div class="stat-value text-lg text-dm">
        <% if @task.duration_ms %>
          <%= (@task.duration_ms / 1000.0).round(1) %><span class="text-sm font-normal ml-0.5">s</span>
        <% else %>
          <span class="text-dm-subtle">—</span>
        <% end %>
      </div>
    </div>
    <div class="stat-card bg-dm-surface border border-dm">
      <div class="stat-label text-dm-muted">Steps</div>
      <div class="stat-value text-lg text-dm">
        <%= @task.steps_executed %><span class="text-sm font-normal text-dm-muted"> / <%= @task.max_steps %></span>
      </div>
    </div>
    <div class="stat-card bg-dm-surface border border-dm">
      <div class="stat-label text-dm-muted">Tokens</div>
      <div class="stat-value text-lg text-dm">
        <% if @task.total_tokens > 0 %>
          <%= number_with_delimiter(@task.total_tokens) %>
        <% else %>
          <span class="text-dm-subtle">—</span>
        <% end %>
      </div>
    </div>
    <div class="stat-card bg-dm-surface border border-dm">
      <div class="stat-label text-dm-muted">Screenshots</div>
      <div class="stat-value text-lg text-dm">
        <% if @task.screenshots.attached? %>
          <%= @task.screenshots.count %>
        <% else %>
          <span class="text-dm-subtle">0</span>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-12 gap-6">
    <!-- Left Column - Main Content -->
    <div class="col-span-8 space-y-6">

      <!-- Result Section -->
      <% if @task.result.present? %>
        <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
          <div class="px-5 py-3 flex items-center gap-2 border-b" style="background: var(--dm-success-bg); border-color: var(--dm-success-border);">
            <svg class="w-4 h-4" style="color: var(--dm-success);" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-[13px] font-medium" style="color: var(--dm-success);">Task Result</span>
          </div>
          <div class="p-5">
            <p class="text-[14px] leading-relaxed whitespace-pre-wrap text-dm"><%= @task.result %></p>
          </div>
        </div>
      <% end %>

      <!-- Error Section -->
      <% if @task.error_message.present? %>
        <div class="rounded-xl overflow-hidden bg-dm-surface" style="border: 1px solid var(--dm-error-border);">
          <div class="px-5 py-3 flex items-center gap-2" style="background: var(--dm-error-bg); border-bottom: 1px solid var(--dm-error-border);">
            <svg class="w-4 h-4" style="color: var(--dm-error);" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
            <span class="text-[13px] font-medium" style="color: var(--dm-error);">Error</span>
          </div>
          <div class="p-5">
            <p class="text-[14px] leading-relaxed font-mono" style="color: var(--dm-error);"><%= @task.error_message %></p>
          </div>
        </div>
      <% end %>

      <!-- Extracted Data -->
      <% if @task.extracted_data.present? && @task.extracted_data.any? %>
        <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
          <div class="px-5 py-3 flex items-center justify-between border-b border-dm">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" style="color: var(--dm-info);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/>
              </svg>
              <span class="text-[13px] font-medium text-dm">Extracted Data</span>
            </div>
            <button onclick="copyToClipboard(this, '<%= j(JSON.generate(@task.extracted_data)) %>')"
                    class="text-[12px] px-2.5 py-1 rounded-lg transition-colors text-dm-muted bg-dm-hover hover:bg-dm-active">
              Copy JSON
            </button>
          </div>
          <div class="p-4">
            <pre class="text-[12px] overflow-x-auto p-4 rounded-lg leading-relaxed text-dm" style="background: var(--dm-code-bg);"><%= JSON.pretty_generate(@task.extracted_data) %></pre>
          </div>
        </div>
      <% end %>

      <!-- Screenshots Gallery -->
      <% if @task.screenshots.attached? %>
        <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
          <div class="px-5 py-3 flex items-center justify-between border-b border-dm">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4 text-dm-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
              <span class="text-[13px] font-medium text-dm">Screenshots</span>
              <span class="text-[12px] px-2 py-0.5 rounded-full bg-dm-surface-light text-dm-muted"><%= @task.screenshots.count %></span>
            </div>
            <button onclick="openReplayModal()" class="text-[12px] px-2.5 py-1 rounded-lg transition-colors text-dm-muted bg-dm-hover hover:bg-dm-active flex items-center gap-1">
              <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
              </svg>
              Play All
            </button>
          </div>
          <div class="p-4">
            <div class="flex gap-3 overflow-x-auto pb-2 -mx-1 px-1" style="scrollbar-width: thin;">
              <% @task.screenshots.each_with_index do |screenshot, index| %>
                <div class="relative flex-shrink-0 group cursor-pointer" onclick="openReplayModalAt(<%= index %>)">
                  <div class="w-40 h-24 rounded-lg overflow-hidden border-2 border-transparent transition-all group-hover:border-orange-400 group-hover:shadow-lg bg-dm-surface-light">
                    <%= image_tag public_storage_url(screenshot),
                        class: "w-full h-full object-cover object-top transition-transform group-hover:scale-105" %>
                  </div>
                  <div class="absolute bottom-1.5 left-1.5 px-1.5 py-0.5 rounded text-[10px] font-medium" style="background: rgba(0,0,0,0.75); color: white;">
                    <%= index + 1 %>
                  </div>
                  <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center" style="background: rgba(0,0,0,0.6);">
                      <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
                      </svg>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Execution Steps -->
      <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
        <div class="px-5 py-3 flex items-center gap-2 border-b border-dm">
          <svg class="w-4 h-4 text-dm-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
          </svg>
          <span class="text-[13px] font-medium text-dm">Execution Steps</span>
          <span class="text-[12px] px-2 py-0.5 rounded-full bg-dm-surface-light text-dm-muted"><%= @steps.count %></span>
        </div>

        <% if @steps.any? %>
          <div class="divide-y divide-dm-border-light">
            <% @steps.each do |step| %>
              <div class="px-5 py-3 flex items-start gap-4 bg-dm-hover transition-colors">
                <!-- Step Number -->
                <div class="flex-shrink-0 w-7 h-7 rounded-full flex items-center justify-center text-[11px] font-semibold" style="background: <%= step.success ? 'var(--dm-success-bg)' : 'var(--dm-error-bg)' %>; color: <%= step.success ? 'var(--dm-success)' : 'var(--dm-error)' %>;">
                  <% if step.success %>
                    <%= step.position %>
                  <% else %>
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                    </svg>
                  <% end %>
                </div>

                <!-- Step Content -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center flex-wrap gap-2">
                    <span class="text-[13px] font-medium px-2 py-0.5 rounded bg-dm-surface-light text-dm"><%= step.action %></span>
                    <% if step.duration_ms %>
                      <span class="text-[11px] text-dm-subtle"><%= step.duration_ms %>ms</span>
                    <% end %>
                    <% if step.total_tokens > 0 %>
                      <span class="text-[11px] px-1.5 py-0.5 rounded" style="background: var(--dm-warning-bg); color: var(--dm-warning);"><%= number_with_delimiter(step.total_tokens) %> tokens</span>
                    <% end %>
                  </div>
                  <% if step.selector.present? %>
                    <p class="text-[12px] font-mono mt-1.5 truncate text-dm-muted"><%= step.selector %></p>
                  <% end %>
                  <% if step.value.present? %>
                    <p class="text-[12px] mt-1 text-dm-muted">
                      <span class="font-medium">Value:</span> <%= step.value.to_s.truncate(80) %>
                    </p>
                  <% end %>
                  <% if step.error_message.present? %>
                    <p class="text-[12px] mt-1.5 px-2 py-1 rounded" style="background: var(--dm-error-bg); color: var(--dm-error);"><%= step.error_message %></p>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <div class="px-5 py-8 text-center">
            <svg class="w-8 h-8 mx-auto mb-2 text-dm-subtle" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
            </svg>
            <p class="text-[13px] text-dm-subtle">No steps recorded</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Right Column - Sidebar -->
    <div class="col-span-4 space-y-5">

      <!-- Details Card -->
      <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
        <div class="px-4 py-3 bg-dm-surface-light border-b border-dm">
          <h3 class="text-[12px] font-semibold uppercase tracking-wider text-dm-muted">Details</h3>
        </div>
        <div class="p-4">
          <dl class="space-y-4">
            <div class="flex items-start justify-between">
              <dt class="text-[12px] text-dm-subtle">Task ID</dt>
              <dd class="text-[12px] font-mono text-right text-dm"><%= @task.id.to_s[0..7] %>...</dd>
            </div>
            <% if @task.final_url.present? %>
              <div>
                <dt class="text-[12px] mb-1 text-dm-subtle">Final URL</dt>
                <dd class="text-[12px] break-all leading-relaxed text-dm"><%= @task.final_url %></dd>
              </div>
            <% end %>
            <div class="flex items-start justify-between">
              <dt class="text-[12px] text-dm-subtle">Triggered By</dt>
              <dd class="text-[12px] capitalize text-dm"><%= @task.triggered_by || 'API' %></dd>
            </div>
            <% if @task.total_tokens > 0 %>
              <div>
                <dt class="text-[12px] mb-1 text-dm-subtle">Token Usage</dt>
                <dd class="text-[12px] text-dm">
                  <div class="flex items-center gap-3">
                    <span class="px-2 py-0.5 rounded" style="background: var(--dm-success-bg); color: var(--dm-success);">In: <%= number_with_delimiter(@task.total_input_tokens || 0) %></span>
                    <span class="px-2 py-0.5 rounded" style="background: var(--dm-warning-bg); color: var(--dm-warning);">Out: <%= number_with_delimiter(@task.total_output_tokens || 0) %></span>
                  </div>
                </dd>
              </div>
            <% end %>
            <% if @task.viewport.present? %>
              <div class="flex items-start justify-between">
                <dt class="text-[12px] text-dm-subtle">Viewport</dt>
                <dd class="text-[12px] font-mono text-dm"><%= @task.viewport['width'] %> x <%= @task.viewport['height'] %></dd>
              </div>
            <% end %>
          </dl>
        </div>
      </div>

      <!-- Timeline Card -->
      <div class="rounded-xl overflow-hidden bg-dm-surface border border-dm">
        <div class="px-4 py-3 bg-dm-surface-light border-b border-dm">
          <h3 class="text-[12px] font-semibold uppercase tracking-wider text-dm-muted">Timeline</h3>
        </div>
        <div class="p-4">
          <div class="relative">
            <div class="absolute left-[7px] top-2 bottom-2 w-0.5 bg-dm-border"></div>
            <div class="space-y-4">
              <div class="flex items-start gap-3">
                <div class="w-4 h-4 rounded-full border-2 flex-shrink-0 mt-0.5 bg-dm-surface border-dm-subtle"></div>
                <div>
                  <p class="text-[12px] font-medium text-dm">Created</p>
                  <p class="text-[11px] text-dm-subtle"><%= @task.created_at.strftime("%b %d, %Y at %H:%M:%S") %></p>
                </div>
              </div>
              <% if @task.completed_at %>
                <div class="flex items-start gap-3">
                  <div class="w-4 h-4 rounded-full border-2 flex-shrink-0 mt-0.5" style="background: <%= @task.status == 'completed' ? 'var(--dm-success)' : 'var(--dm-error)' %>; border-color: <%= @task.status == 'completed' ? 'var(--dm-success)' : 'var(--dm-error)' %>;"></div>
                  <div>
                    <p class="text-[12px] font-medium text-dm"><%= @task.status == 'completed' ? 'Completed' : 'Finished' %></p>
                    <p class="text-[11px] text-dm-subtle"><%= @task.completed_at.strftime("%b %d, %Y at %H:%M:%S") %></p>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>

      <!-- Retried From -->
      <% retried_from = @task.metadata&.dig('retried_from') || @task.metadata&.dig('replayed_from') %>
      <% if retried_from %>
        <div class="rounded-xl p-4 flex items-center gap-3" style="background: var(--dm-info-bg); border: 1px solid var(--dm-info-border);">
          <svg class="w-5 h-5 flex-shrink-0" style="color: var(--dm-info);" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          <div>
            <p class="text-[12px] font-medium" style="color: var(--dm-info);">Retried from</p>
            <%= link_to dashboard_project_ai_task_path(@project, retried_from), class: "text-[12px] font-mono underline", style: "color: var(--dm-info);" do %>
              <%= retried_from.to_s[0..7] %>...
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- Replay Modal -->
<% if @task.screenshots.attached? %>
<div id="replayModal" class="fixed inset-0 z-50 hidden" style="background: rgba(0,0,0,0.95);">
  <!-- Top Bar -->
  <div class="absolute top-0 left-0 right-0 h-16 flex items-center justify-between px-6" style="background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);">
    <div class="flex items-center gap-4">
      <span id="stepCounter" class="text-[14px] font-medium text-white/80">Step 1 of <%= @task.screenshots.count %></span>
      <span id="stepAction" class="text-[13px] px-3 py-1 rounded-lg text-white/90" style="background: rgba(255,255,255,0.1);"></span>
    </div>
    <div class="flex items-center gap-3">
      <button onclick="toggleAutoplay()" id="autoplayBtn"
          class="px-4 py-2 rounded-lg text-[13px] font-medium text-white transition-all hover:scale-105"
          style="background: linear-gradient(135deg, #D97706 0%, #EA580C 100%); box-shadow: 0 4px 12px rgba(217, 119, 6, 0.4);">
        <span class="flex items-center gap-2">
          <svg id="playIcon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"/>
          </svg>
          <svg id="pauseIcon" class="w-4 h-4 hidden" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
          </svg>
          <span id="autoplayText">Auto Play</span>
        </span>
      </button>
      <button onclick="closeReplayModal()" class="p-2 rounded-lg text-white/70 hover:text-white hover:bg-white/10 transition-colors">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Main Image Area -->
  <div class="absolute inset-0 flex items-center justify-center" style="top: 64px; bottom: 100px; left: 80px; right: 80px;">
    <img id="replayImage" src="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
  </div>

  <!-- Navigation Arrows -->
  <button onclick="prevStep()" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full flex items-center justify-center text-white/60 hover:text-white hover:bg-white/10 transition-all">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
    </svg>
  </button>
  <button onclick="nextStep()" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full flex items-center justify-center text-white/60 hover:text-white hover:bg-white/10 transition-all">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
    </svg>
  </button>

  <!-- Progress Bar & Thumbnails -->
  <div class="absolute bottom-0 left-0 right-0 px-6 pb-6">
    <!-- Progress Bar -->
    <div class="w-full h-1 rounded-full mb-4 overflow-hidden" style="background: rgba(255,255,255,0.2);">
      <div id="progressBar" class="h-full rounded-full transition-all duration-300" style="background: #D97706; width: 0%;"></div>
    </div>

    <!-- Thumbnail Strip -->
    <div class="flex items-center justify-center gap-2 overflow-x-auto pb-2" style="scrollbar-width: none;">
      <% @task.screenshots.each_with_index do |screenshot, index| %>
        <button onclick="goToStep(<%= index %>)"
            class="stepThumb flex-shrink-0 w-16 h-10 rounded overflow-hidden border-2 transition-all hover:scale-105"
            data-index="<%= index %>"
            style="border-color: transparent; opacity: 0.5;">
          <%= image_tag public_storage_url(screenshot), class: "w-full h-full object-cover object-top" %>
        </button>
      <% end %>
    </div>
  </div>
</div>

<script>
  const screenshots = [
    <% @task.screenshots.each_with_index do |screenshot, index| %>
      { url: "<%= public_storage_url(screenshot) %>", step: <%= index + 1 %> },
    <% end %>
  ];

  const steps = [
    <% @steps.each do |step| %>
      { action: "<%= step.action %>", selector: "<%= j(step.selector.to_s.truncate(50)) %>" },
    <% end %>
  ];

  let currentStep = 0;
  let autoplayInterval = null;

  function openReplayModal() {
    document.getElementById('replayModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    goToStep(0);
  }

  function openReplayModalAt(index) {
    document.getElementById('replayModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    goToStep(index);
  }

  function closeReplayModal() {
    document.getElementById('replayModal').classList.add('hidden');
    document.body.style.overflow = '';
    stopAutoplay();
  }

  function goToStep(index) {
    currentStep = index;
    if (currentStep < 0) currentStep = screenshots.length - 1;
    if (currentStep >= screenshots.length) currentStep = 0;

    document.getElementById('replayImage').src = screenshots[currentStep].url;
    document.getElementById('stepCounter').textContent = `Step ${currentStep + 1} of ${screenshots.length}`;

    // Update progress bar
    const progress = ((currentStep + 1) / screenshots.length) * 100;
    document.getElementById('progressBar').style.width = `${progress}%`;

    const stepInfo = steps[currentStep];
    const actionEl = document.getElementById('stepAction');
    if (stepInfo && stepInfo.action) {
      actionEl.textContent = stepInfo.action + (stepInfo.selector ? ': ' + stepInfo.selector : '');
      actionEl.style.display = 'inline-block';
    } else {
      actionEl.style.display = 'none';
    }

    // Update thumbnails
    document.querySelectorAll('.stepThumb').forEach((thumb, i) => {
      if (i === currentStep) {
        thumb.style.borderColor = '#D97706';
        thumb.style.opacity = '1';
      } else {
        thumb.style.borderColor = 'transparent';
        thumb.style.opacity = '0.5';
      }
    });
  }

  function nextStep() { goToStep(currentStep + 1); }
  function prevStep() { goToStep(currentStep - 1); }

  function toggleAutoplay() {
    if (autoplayInterval) {
      stopAutoplay();
    } else {
      startAutoplay();
    }
  }

  function startAutoplay() {
    document.getElementById('playIcon').classList.add('hidden');
    document.getElementById('pauseIcon').classList.remove('hidden');
    document.getElementById('autoplayText').textContent = 'Pause';
    document.getElementById('autoplayBtn').style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';

    autoplayInterval = setInterval(() => {
      if (currentStep >= screenshots.length - 1) {
        stopAutoplay();
      } else {
        nextStep();
      }
    }, 1500);
  }

  function stopAutoplay() {
    if (autoplayInterval) {
      clearInterval(autoplayInterval);
      autoplayInterval = null;
    }
    document.getElementById('playIcon').classList.remove('hidden');
    document.getElementById('pauseIcon').classList.add('hidden');
    document.getElementById('autoplayText').textContent = 'Auto Play';
    document.getElementById('autoplayBtn').style.background = 'linear-gradient(135deg, #D97706 0%, #EA580C 100%)';
  }

  function copyToClipboard(button, text) {
    navigator.clipboard.writeText(text).then(() => {
      const original = button.textContent;
      button.textContent = 'Copied!';
      setTimeout(() => { button.textContent = original; }, 1500);
    });
  }

  document.addEventListener('keydown', (e) => {
    if (!document.getElementById('replayModal').classList.contains('hidden')) {
      if (e.key === 'Escape') closeReplayModal();
      if (e.key === 'ArrowLeft') prevStep();
      if (e.key === 'ArrowRight') nextStep();
      if (e.key === ' ') { e.preventDefault(); toggleAutoplay(); }
    }
  });
</script>
<% end %>
