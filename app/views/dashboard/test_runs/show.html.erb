<% content_for(:title) { "Test Run" } %>

<div class="space-y-8">
  <div>
    <div class="mb-2">
      <%= link_to dashboard_project_test_runs_path(@project), class: "btn-ghost text-sm" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Back to Test Runs
      <% end %>
    </div>
    <div class="flex items-center justify-between">
      <div>
        <h1 class="section-header">
          Test Run #<%= @test_run.id.to_s[0..7] %>
        </h1>
        <% if @test_run.name.present? %>
          <p class="section-subheader"><%= @test_run.name %></p>
        <% end %>
      </div>
      <% case @test_run.status %>
      <% when 'pending' %>
        <span class="badge badge-neutral">Pending</span>
      <% when 'running' %>
        <span class="badge badge-info">Running</span>
      <% when 'completed' %>
        <span class="badge badge-success">Completed</span>
      <% when 'failed' %>
        <span class="badge badge-error">Failed</span>
      <% end %>
    </div>
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-4 gap-4">
    <div class="stat-card text-center">
      <div class="stat-value"><%= @comparisons.count %></div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat-card text-center">
      <div class="stat-value text-green-600"><%= @comparisons.select { |c| c.status == 'passed' }.count %></div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat-card text-center">
      <div class="stat-value text-red-600"><%= @comparisons.select { |c| c.status == 'failed' }.count %></div>
      <div class="stat-label">Failed</div>
    </div>
    <div class="stat-card text-center">
      <div class="stat-value text-amber-600"><%= @comparisons.select { |c| c.status == 'pending' }.count %></div>
      <div class="stat-label">Pending</div>
    </div>
  </div>

  <!-- Comparisons -->
  <div class="space-y-4">
    <h2 class="text-[15px] font-semibold text-stone-900">Comparisons</h2>

    <% if @comparisons.any? %>
      <div class="card overflow-hidden">
        <table class="table">
          <thead>
            <tr>
              <th>Page</th>
              <th>Status</th>
              <th>Diff %</th>
              <th>Browser</th>
              <th class="text-right"></th>
            </tr>
          </thead>
          <tbody>
            <% @comparisons.each do |comparison| %>
              <tr>
                <td>
                  <%= link_to comparison.page&.name || 'Unknown', dashboard_project_comparison_path(@project, comparison), class: "font-medium text-stone-900 hover:text-amber-600" %>
                </td>
                <td>
                  <% case comparison.status %>
                  <% when 'passed' %>
                    <span class="badge badge-success">Passed</span>
                  <% when 'failed' %>
                    <span class="badge badge-error">Failed</span>
                  <% when 'pending' %>
                    <span class="badge badge-neutral">Pending</span>
                  <% when 'approved' %>
                    <span class="badge badge-info">Approved</span>
                  <% when 'rejected' %>
                    <span class="badge badge-warning">Rejected</span>
                  <% end %>
                </td>
                <td>
                  <% if comparison.diff_percentage.present? %>
                    <span class="<%= comparison.diff_percentage > 1 ? 'text-red-600' : 'text-stone-600' %>">
                      <%= number_to_percentage(comparison.diff_percentage, precision: 2) %>
                    </span>
                  <% else %>
                    <span class="text-stone-400">-</span>
                  <% end %>
                </td>
                <td class="text-stone-600">
                  <%= comparison.snapshot&.browser_config&.browser || 'chromium' %>
                </td>
                <td class="text-right">
                  <%= link_to "View", dashboard_project_comparison_path(@project, comparison), class: "btn-ghost btn-sm" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="card">
        <div class="empty-state py-12">
          <p class="empty-state-description">No comparisons yet</p>
        </div>
      </div>
    <% end %>
  </div>
</div>
